@namespace demoVer.Shared
@inherits LayoutComponentBase
@using demoVer.Models
@using System
@using System.IO
@using System.Text.Json
@using Newtonsoft.Json.Linq
@inject IWebHostEnvironment WebHostEnvironment

@switch(currentCardInfo.card_Type)
{
    case CardType.Info:
        switch(INFO_setting_stage)
        {
            case INFO_SETTING_STAGE.ADD_ROW_STAGE:
                <div class="edit-info-top">
                    <input class="input-edit" @bind=edit_CardName placeholder="Ëº∏ÂÖ•Âç°ÁâáÂêçÁ®±" style="text-align: center;"/>
                </div>
                <br>
                @* <div class="underline"></div> *@
                <table class="table">
                    <thead>
                        <tr>
                            <th>ÂúñÁ§∫</th>
                            <th>ÂÖßÂÆπË®≠ÂÆö</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(int i = 0 ; i < edit_INFO_DataItems.Count ; i ++)
                        {
                            var temp = edit_INFO_DataItems[i];
                            string iconPath;
                            iconPath = (string.IsNullOrEmpty(temp.iconPath)) ? "images/square.png" : temp.iconPath;
                            <tr>
                                <td>
                                    <button class="icon-button" @onclick="() => selectImg(temp)">
                                        <img src=@iconPath alt="waitImg"/>
                                    </button>
                                </td>
                                <td class="clickable-td" @onclick="() => AdjustValueCmdRow(temp)">
                                    @(temp.status switch
                                        {
                                            SettingStatus.YET => "Ë®≠ÂÆö",
                                            SettingStatus.PROGRESS => "Ë®≠ÂÆöÊú™ÂÆåÊàê",
                                            SettingStatus.DONE => "Ë®≠ÂÆöÂÆåÊàê",
                                            _ => ""
                                        }
                                    )
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="confirm-cancel-container">
                    <MudButton OnClick="Add_INFO_DataItem"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            StartIcon="@Icons.Material.Filled.Add"
                            Style="width: 120px;">
                        Êñ∞Â¢û
                    </MudButton>
                    <MudButton OnClick="Confirm_INFO_DataItem"
                            Variant="Variant.Filled"
                            Color="Color.Success"
                            Style="width: 120px;">
                        Á¢∫ÂÆö
                    </MudButton>
                </div>
                break;
            case INFO_SETTING_STAGE.SELECT_ICON_STAGE:
                <div class="img-select-grid">
                    @foreach(var imgPath in imgRelativePaths)
                    {
                        <div class="img-select-icon">
                            <button class="icon-button" @onclick="() => selectedImgFile(imgPath)">
                                <img src=@imgPath alt="waiting"/>
                            </button>
                        </div>
                    }
                </div>
                break;
            case INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE:
                <div class="edit-info-top">
                    <h3>Êï∏ÂÄºËàáÂëΩ‰ª§Ë®≠ÂÆö</h3>
                </div>
                <table class="table">
                    <tbody>
                        @if(currentEdit_INFO_DataFormat_ref != null)
                        {
                            <tr>
                                <th>Ë®≠ÂÇôÈÅ∏Êìá</th>
                                <td class="clickable-td" @onclick="() => selectMachine()">
                                    @(string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.MachineName) ? "Ë®≠ÂÆö" : currentEdit_INFO_DataFormat_ref.MachineName)
                                </td>
                            </tr>
                            <tr>
                                <th>ÂëΩ‰ª§ÈÅ∏Êìá</th>
                                <td class="clickable-td" @onclick="() => selectCMD()">
                                    @(string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.Cmd) ? "Ë®≠ÂÆö" : currentEdit_INFO_DataFormat_ref.Cmd)
                                </td>
                            </tr>
                            <tr>
                                <th>Êï∏ÂÄºÂêçÁ®±</th>
                                <td>
                                    <input @bind="currentEdit_INFO_DataFormat_ref.ValueName" class="td-input"  style="text-align: center;"/>
                                </td>
                            </tr>
                            <tr>
                                <th>ÂñÆ‰Ωç</th>
                                <td class="clickable-td" @onclick="() => selectUnit()" style="text-align: center;">
                                    @{
                                        string Uint_To_show = "";
                                        if(string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.Cmd))
                                        {
                                            Uint_To_show = "Ë´ãÂÖàÈÅ∏ÊìáÂëΩ‰ª§";
                                        }
                                        else
                                        {
                                            if(string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.Unit))
                                            {
                                                Uint_To_show = "Ë®≠ÂÆö";
                                            }
                                            else
                                            {
                                                Uint_To_show = currentEdit_INFO_DataFormat_ref.Unit;
                                            }
                                        }
                                    }
                                    @Uint_To_show
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="confirm-cancel-container">
                     <MudButton OnClick="confirm_INFO_DataFormat_ValueSetting"
                            Variant="Variant.Filled"
                            Color="Color.Success">
                        Á¢∫ÂÆö
                    </MudButton>
                    @* <button @onclick="confirm_INFO_DataFormat_ValueSetting">Á¢∫Ë™ç</button> *@
                </div>
                break;
            case INFO_SETTING_STAGE.MACHINE_SELECTION_STAGE:
                <div class="scrollable-list">
                    @foreach (var item in machineNameLists)
                    {
                        <div class="list-item" @onclick="() => clickMachineName(item)">@item</div>
                    }
                </div>
                break;
            case INFO_SETTING_STAGE.CMD_SELECTION_STAGE:
                <div class="scrollable-list">
                    @foreach (var item in cmdDict)
                    {
                        <div class="list-item" @onclick="() => clickCmd(item.Key)" style="text-align: ">@item.Key</div>
                    }
                </div>
                break;
            case INFO_SETTING_STAGE.UNIT_SELECTION_STAGE:
                <div class="scrollable-list">
                    @foreach (var unit in UnitLists)
                    {
                        <div class="list-item" @onclick="() => clickUnit(unit)">@unit</div>
                    }
                </div>
                break;
            
            case INFO_SETTING_STAGE.ADD_VALUE_AND_CMD_ROW_STAGE:
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <th>Êï∏ÂÄºÂêçÁ®±</th>
                            <th>ÂñÆ‰Ωç</th>
                        </thead>
                        <tbody>
                            @foreach(var tempDataFormat in currentEdit_INFO_DataItem_ref.INFO_DataFormats)
                            {
                                <tr>
                                    <td class="clickable-td" @onclick="() => setValueAndCmd(tempDataFormat)">
                                        @(string.IsNullOrEmpty(tempDataFormat.ValueName) ? "ÈªûÊìäË®≠ÂÆö" : tempDataFormat.ValueName)
                                    </td>
                                    <td>
                                        @(string.IsNullOrEmpty(tempDataFormat.Unit) ? "" : tempDataFormat.Unit)
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @* <button @onclick="AddRow_ValueAndCmd">Êñ∞Â¢û</button> *@
                <div class="confirm-cancel-container">
                    <MudButton OnClick="AddRow_ValueAndCmd"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            StartIcon="@Icons.Material.Filled.Add"
                            Style="width: 120px;">
                        Êñ∞Â¢û
                    </MudButton>
                    <MudButton OnClick="confirm_INFO_DataFormats_Setting"
                                Variant="Variant.Filled"
                                Color="Color.Success"
                                Style="width: 120px;">
                        Á¢∫Ë™ç
                    </MudButton>
                </div>
                break;

            default:
                break;
        }
        
        break;
    case CardType.Chart:
        <h3>Á∑®ËºØ : ÂúñË°®</h3>
        break;
    case CardType.Status:
        <h3>Á∑®ËºØ : ÈÄ£Êé•ÁãÄÊÖã</h3>
        break;
    default:
        break;
}




@code{
    //DEBUG
    private List<string> machineNameLists = new List<string>()
    {
         "Á¨¨‰∏ÄË°åË≥áÊñô", "Á¨¨‰∫åË°åË≥áÊñô", "Á¨¨‰∏âË°åË≥áÊñô", "Á¨¨ÂõõË°åË≥áÊñô",
        "Á¨¨‰∫îË°åË≥áÊñô", "Á¨¨ÂÖ≠Ë°åË≥áÊñô", "Á¨¨‰∏ÉË°åË≥áÊñô", "Á¨¨ÂÖ´Ë°åË≥áÊñô"
    };

    @* private List<string> cmdLists = new List<string>()
    {
        "Current", "Voltage", "Á¨¨‰∏âË°åÂëΩ‰ª§", "Á¨¨ÂõõË°åÂëΩ‰ª§",
        "Á¨¨‰∫îË°åÂëΩ‰ª§", "Á¨¨ÂÖ≠Ë°åÂëΩ‰ª§", "Á¨¨‰∏ÉË°åÂëΩ‰ª§", "Á¨¨ÂÖ´Ë°åÂëΩ‰ª§"
    }; *@

    

    [Parameter] public CardInfo currentCardInfo {get; set;}
    [Parameter] public EventCallback<CardInfo> OnCardInfoUpdated {get; set;}


    private bool _isFirstParameterSet = true;
    private INFO_SETTING_STAGE INFO_setting_stage = INFO_SETTING_STAGE.ADD_ROW_STAGE;
    private string title;
    private string imgFolderPath = "";
    private List<string> imgRelativePaths = new List<string>();
    
    private INFO_DataItem currentEdit_INFO_DataItem_ref; //reference, modify in memory
    private INFO_DataItem temp_INFO_DataItem_Backend;
    private INFO_DataFormat currentEdit_INFO_DataFormat_ref; //This is point to the one DataFormat of temp_INFO_DataItem_Backend.INFO_DataFormats
    private JObject cmdDict;
    private string edit_CardName;
    string Cmd_filePath = "CMD_and_Unit.json";

    private List<string> UnitLists;

    protected override void OnInitialized()
    {
        Console.WriteLine("üöÄ ÂÖÉ‰ª∂ÂàùÂßãÂåñÔºöOnInitialized Ë¢´ÂëºÂè´");
        // ÂàùÂßãÂåñÈÇèËºØÔºå‰æãÂ¶ÇÂª∫Á´ãÈ†êË®≠ÂÄº„ÄÅËÆÄÂèñ localStorage„ÄÅË®≠ÂÆöËÆäÊï∏Á≠â
        imgFolderPath = Path.Combine(WebHostEnvironment.WebRootPath, "images/user_selections");
        getCMDs();
        getImgFiles();
    }
    
    protected override void OnParametersSet()
    {
        if (_isFirstParameterSet)
        {
            _isFirstParameterSet = false;

            // ‚úÖ Á¨¨‰∏ÄÊ¨°Êé•Êî∂Âà∞ [Parameter] ÊôÇË¶ÅÂü∑Ë°åÁöÑÈÇèËºØ
            Console.WriteLine("üöÄ Á¨¨‰∏ÄÊ¨°Êé•Êî∂Âà∞ÂèÉÊï∏ currentCardInfoÔºÅ");
            if(!string.IsNullOrEmpty(currentCardInfo.cardName))
            {
                Console.WriteLine("[EditCard] : currentCardInfo.cardName = " + currentCardInfo.cardName);
                edit_CardName = currentCardInfo.cardName;
            }
        }
    }

    private List<INFO_DataItem> edit_INFO_DataItems = new List<INFO_DataItem>
    {
        new INFO_DataItem()
        {
            iconPath = "images/user_selections/car-battery.png",
            status = SettingStatus.DONE,
            INFO_DataFormats = new List<INFO_DataFormat>{
                new INFO_DataFormat()
                {
                    MachineName = "123",
                    Cmd = "Current",
                    ValueName = "Test",
                    Unit = "A"
                }
            }
        }
    };

    private void getImgFiles()
    {
        if(Directory.Exists(imgFolderPath))
        {
            
            imgRelativePaths = Directory.GetFiles(imgFolderPath)
                                    .Select(path => "images/user_selections/" + Path.GetFileName(path))
                                    .ToList();
            foreach(var names in imgRelativePaths)
            {
                Console.WriteLine(names);
            }
        }
        else
        {
            Console.WriteLine("FAIL : getImgFiles");
        }
    }

    private async Task getCMDs()
    {
        if(File.Exists(Cmd_filePath))
        {
            string json = File.ReadAllText(Cmd_filePath);
            cmdDict = JObject.Parse(json);

            @* var json = await File.ReadAllTextAsync(Cmd_filePath);
            cmdDict = JsonSerializer.Deserialize<Dictionary<string, object>>(json);

            var jsonString = JsonSerializer.Serialize(cmdDict, new JsonSerializerOptions { WriteIndented = true });
            Console.WriteLine(jsonString); *@

        }
    }

    private void Add_INFO_DataItem()
    {
        edit_INFO_DataItems.Add(new INFO_DataItem());
    }

    private void selectImg(INFO_DataItem _temp_Info_DataItem)
    {
        currentEdit_INFO_DataItem_ref = _temp_Info_DataItem; 
        INFO_setting_stage = INFO_SETTING_STAGE.SELECT_ICON_STAGE;
    }

    private void selectedImgFile(string _imgPath)
    {
        Console.WriteLine(_imgPath);

        currentEdit_INFO_DataItem_ref.iconPath = _imgPath;
        INFO_setting_stage = INFO_SETTING_STAGE.ADD_ROW_STAGE;
    }

    private void AdjustValueCmdRow(INFO_DataItem _temp_Info_DataItem)
    {
        Console.WriteLine("AdjustValueCmdRow");

        //Â¶ÇÊûúÊòØÂ∑≤Á∂ìÂ≠òÂú®ÁöÑ currentEdit_INFO_DataItemÔºåÂâá

        currentEdit_INFO_DataItem_ref = _temp_Info_DataItem;
        
        INFO_setting_stage = INFO_SETTING_STAGE.ADD_VALUE_AND_CMD_ROW_STAGE;
    }

    private void AddRow_ValueAndCmd()
    {
        currentEdit_INFO_DataItem_ref.INFO_DataFormats.Add(new INFO_DataFormat());
    }

    private void setValueAndCmd(INFO_DataFormat _temp_DataFormat)
    {
        Console.WriteLine("setValueAndCmd");
        currentEdit_INFO_DataFormat_ref = _temp_DataFormat;
        INFO_setting_stage = INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE;
    }

    private void selectMachine()
    {
        Console.WriteLine("selectMachine");
        INFO_setting_stage = INFO_SETTING_STAGE.MACHINE_SELECTION_STAGE;
    }

    private void selectCMD()
    {
        Console.WriteLine("selectCMD");
        INFO_setting_stage = INFO_SETTING_STAGE.CMD_SELECTION_STAGE;
    }

    private void selectUnit()
    {
        Console.WriteLine("selectUnit");
        if(!string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.Cmd))
        {
            Console.WriteLine("selectUnit : currentEdit_INFO_DataFormat_ref.Cmd = " + currentEdit_INFO_DataFormat_ref.Cmd);
            if(cmdDict.ContainsKey(currentEdit_INFO_DataFormat_ref.Cmd))
            {
                var unitToken = cmdDict[currentEdit_INFO_DataFormat_ref.Cmd]["Unit"];
                if(unitToken != null)
                {
                    UnitLists = cmdDict[currentEdit_INFO_DataFormat_ref.Cmd]["Unit"].ToObject<List<string>>();
                }
            }
            INFO_setting_stage = INFO_SETTING_STAGE.UNIT_SELECTION_STAGE;
        }
        else
        {
            Console.WriteLine("selectUnit : Â∞öÊú™ÈÅ∏ÊìáCMD (ÈÄôÈÇäÂèØ‰ª•Ë∑≥ÂÄãAlertÊ°Ü)");
        }
    }

    private void clickMachineName(string _selectedMachineName)
    {
        currentEdit_INFO_DataFormat_ref.MachineName = _selectedMachineName;
        INFO_setting_stage = INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE;
    }
    private void clickCmd(string _cmd)
    {
        if(currentEdit_INFO_DataFormat_ref.Cmd != _cmd)
        {
            currentEdit_INFO_DataFormat_ref.Cmd = _cmd;
            currentEdit_INFO_DataFormat_ref.Unit = "";
        }
        

        INFO_setting_stage = INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE;
    }
    private void clickUnit(string _unit)
    {
        currentEdit_INFO_DataFormat_ref.Unit = _unit;
        INFO_setting_stage = INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE;
    }

    private void confirm_INFO_DataFormat_ValueSetting()
    {
        if( string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.MachineName)      ||
            string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.Cmd)              ||
            string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.ValueName)        ||
            string.IsNullOrEmpty(currentEdit_INFO_DataFormat_ref.Unit)             ) 
        {
            Console.WriteLine("ÊúâÊï∏ÂÄºÊ≤íÊúâË®≠ÂÆö");
            return;
        }

        
        @* currentEdit_INFO_DataItem_ref.MachineName   = temp_INFO_DataItem_Backend.MachineName;
        currentEdit_INFO_DataItem_ref.Cmd           = temp_INFO_DataItem_Backend.Cmd;
        currentEdit_INFO_DataItem_ref.ValueName     = temp_INFO_DataItem_Backend.ValueName;
        currentEdit_INFO_DataItem_ref.Unit          = "";
        currentEdit_INFO_DataItem_ref.status        = SettingStatus.DONE; *@
        
        Console.WriteLine("[currentEdit_INFO_DataItem_ref] :");
        string json = JsonSerializer.Serialize(currentEdit_INFO_DataItem_ref, new JsonSerializerOptions{
            WriteIndented = true
        });
        Console.WriteLine(json);


        INFO_setting_stage = INFO_SETTING_STAGE.ADD_VALUE_AND_CMD_ROW_STAGE;
    }
    
    private void confirm_INFO_DataFormats_Setting()
    {
        currentEdit_INFO_DataItem_ref.status = SettingStatus.DONE;
        INFO_setting_stage = INFO_SETTING_STAGE.ADD_ROW_STAGE;
    }

    private void Confirm_INFO_DataItem()
    {
        Console.WriteLine("[edit_INFO_DataItems] : ");
        string json = JsonSerializer.Serialize(edit_INFO_DataItems, new JsonSerializerOptions{
            WriteIndented = true
        });
        Console.WriteLine(json);
    
        currentCardInfo.cardName = edit_CardName;
        currentCardInfo.Info_DataItems = edit_INFO_DataItems;
        
        // ÈÄöÁü•Áà∂ÂÖÉ‰ª∂Êõ¥Êñ∞ currentCardInfo
        OnCardInfoUpdated.InvokeAsync(currentCardInfo);
    }

}