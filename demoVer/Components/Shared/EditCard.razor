@namespace demoVer.Shared
@inherits LayoutComponentBase
@using demoVer.Models
@using System
@using System.IO
@using System.Text.Json
@using Newtonsoft.Json.Linq
@inject IWebHostEnvironment WebHostEnvironment

@switch(currentCardInfo.card_Type)
{
    case CardType.Info:
        switch(INFO_setting_stage)
        {
            case INFO_SETTING_STAGE.ADD_ROW_STAGE:
                <div class="edit-info-top">
                    <input class="input-edit" placeholder="Ëº∏ÂÖ•Âç°ÁâáÂêçÁ®±" style="text-align: center;"/>
                </div>
                @* <div class="underline"></div> *@
                <table class="table">
                    <thead>
                        <tr>
                            <th>ÂúñÁ§∫</th>
                            <th>ÂÖßÂÆπË®≠ÂÆö</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(int i = 0 ; i < INFO_DataItems.Count ; i ++)
                        {
                            var temp_Info_DataItem = INFO_DataItems[i];
                            string iconPath = (string.IsNullOrEmpty(temp_Info_DataItem.iconPath)) ? "images/square.png" : temp_Info_DataItem.iconPath;
                            <tr>
                                <td>
                                    <button class="icon-button" @onclick="() => selectImg(temp_Info_DataItem)">
                                        <img src=@iconPath alt="waitImg"/>
                                    </button>
                                </td>
                                <td class="clickable-td" @onclick="() => setValueAndCmd(temp_Info_DataItem)">
                                    @(temp_Info_DataItem.status switch
                                        {
                                            SettingStatus.YET => "Ë®≠ÂÆö",
                                            SettingStatus.PROGRESS => "Ë®≠ÂÆöÊú™ÂÆåÊàê",
                                            SettingStatus.DONE => temp_Info_DataItem.ValueName,
                                            _ => ""
                                        }
                                    )
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                break;
            case INFO_SETTING_STAGE.SELECT_ICON_STAGE:
                <div class="img-select-grid">
                    @foreach(var imgPath in imgRelativePaths)
                    {
                        <div class="img-select-icon">
                            <button class="icon-button" @onclick="() => selectedImgFile(imgPath)">
                                <img src=@imgPath alt="waiting"/>
                            </button>
                        </div>
                    }
                </div>
                break;
            case INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE:
                <div class="edit-info-top">
                    <h3>Êï∏ÂÄºËàáÂëΩ‰ª§Ë®≠ÂÆö</h3>
                </div>
                <table class="table">
                    <tbody>
                        @for (int i = 0; i < INFO_DataItems.Count; i++)
                        {

                            <tr>
                                <th>Ë®≠ÂÇôÈÅ∏Êìá</th>
                                <td class="clickable-td" @onclick="() => selectMachine()">
                                    @(string.IsNullOrEmpty(temp_INFO_DataItem.MachineName) ? "Ë®≠ÂÆö" : temp_INFO_DataItem.MachineName)
                                </td>
                            </tr>
                            <tr>
                                <th>ÂëΩ‰ª§ÈÅ∏Êìá</th>
                                <td class="clickable-td" @onclick="() => selectCMD()">
                                    @(string.IsNullOrEmpty(temp_INFO_DataItem.Cmd) ? "Ë®≠ÂÆö" : temp_INFO_DataItem.Cmd)
                                </td>
                            </tr>
                            <tr>
                                <th>Êï∏ÂÄºÂêçÁ®±</th>
                                <td>
                                    <input @bind="temp_INFO_DataItem.ValueName" class="td-input"  style="text-align: center;"/>
                                </td>
                            </tr>
                            <tr>
                                <th>ÂñÆ‰Ωç</th>
                                <td class="clickable-td" @onclick="() => selectUnit()">
                                    @{
                                        string Uint_To_show = "";
                                        if(string.IsNullOrEmpty(temp_INFO_DataItem.Cmd))
                                        {
                                            Uint_To_show = "Ë´ãÂÖàÈÅ∏ÊìáÂëΩ‰ª§";
                                        }
                                        else
                                        {
                                            if(string.IsNullOrEmpty(temp_INFO_DataItem.Unit))
                                            {
                                                Uint_To_show = "Ë®≠ÂÆö";
                                            }
                                            else
                                            {
                                                Uint_To_show = temp_INFO_DataItem.Unit;
                                            }
                                        }
                                    }
                                    @Uint_To_show
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="confirm-cancel-container">
                    <button @onclick="confirmInfoValueSetting">Á¢∫Ë™ç</button>
                </div>
                break;
            case INFO_SETTING_STAGE.MACHINE_SELECTION_STAGE:
                <div class="scrollable-list">
                    @foreach (var item in machineNameLists)
                    {
                        <div class="list-item" @onclick="() => clickMachineName(item)">@item</div>
                    }
                </div>
                break;
            case INFO_SETTING_STAGE.CMD_SELECTION_STAGE:
                <div class="scrollable-list">
                    @foreach (var item in cmdDict)
                    {
                        <div class="list-item" @onclick="() => clickCmd(item.Key)">@item.Key</div>
                    }
                </div>
                break;
            case INFO_SETTING_STAGE.UNIT_SELECTION_STAGE:
                <div class="scrollable-list">
                    @foreach (var unit in UnitLists)
                    {
                        <div class="list-item" @onclick="() => clickUnit(unit)">@unit</div>
                    }
                </div>
                break;
            default:
                break;
        }
        
        break;
    case CardType.Chart:
        <h3>Á∑®ËºØ : ÂúñË°®</h3>
        break;
    case CardType.Status:
        <h3>Á∑®ËºØ : ÈÄ£Êé•ÁãÄÊÖã</h3>
        break;
    default:
        break;
}




@code{
    //DEBUG
    private List<string> machineNameLists = new List<string>()
    {
         "Á¨¨‰∏ÄË°åË≥áÊñô", "Á¨¨‰∫åË°åË≥áÊñô", "Á¨¨‰∏âË°åË≥áÊñô", "Á¨¨ÂõõË°åË≥áÊñô",
        "Á¨¨‰∫îË°åË≥áÊñô", "Á¨¨ÂÖ≠Ë°åË≥áÊñô", "Á¨¨‰∏ÉË°åË≥áÊñô", "Á¨¨ÂÖ´Ë°åË≥áÊñô"
    };

    @* private List<string> cmdLists = new List<string>()
    {
        "Current", "Voltage", "Á¨¨‰∏âË°åÂëΩ‰ª§", "Á¨¨ÂõõË°åÂëΩ‰ª§",
        "Á¨¨‰∫îË°åÂëΩ‰ª§", "Á¨¨ÂÖ≠Ë°åÂëΩ‰ª§", "Á¨¨‰∏ÉË°åÂëΩ‰ª§", "Á¨¨ÂÖ´Ë°åÂëΩ‰ª§"
    }; *@

    

    [Parameter] public CardInfo currentCardInfo {get; set;}
    
    private bool _isFirstParameterSet = true;
    private INFO_SETTING_STAGE INFO_setting_stage = INFO_SETTING_STAGE.ADD_ROW_STAGE;
    private string title;
    private string imgFolderPath = "";
    private List<string> imgRelativePaths = new List<string>();
    
    private INFO_DataItem currentEdit_INFO_DataItem;
    private INFO_DataItem temp_INFO_DataItem = new INFO_DataItem();

    private JObject cmdDict;
    string Cmd_filePath = "CMD.json";

    private List<string> UnitLists;

    protected override void OnInitialized()
    {
        Console.WriteLine("üöÄ ÂÖÉ‰ª∂ÂàùÂßãÂåñÔºöOnInitialized Ë¢´ÂëºÂè´");
        // ÂàùÂßãÂåñÈÇèËºØÔºå‰æãÂ¶ÇÂª∫Á´ãÈ†êË®≠ÂÄº„ÄÅËÆÄÂèñ localStorage„ÄÅË®≠ÂÆöËÆäÊï∏Á≠â
        imgFolderPath = Path.Combine(WebHostEnvironment.WebRootPath, "images/user_selections");
        getCMDs();
        getImgFiles();
    }
    
    protected override void OnParametersSet()
    {
        if (_isFirstParameterSet)
        {
            _isFirstParameterSet = false;

            // ‚úÖ Á¨¨‰∏ÄÊ¨°Êé•Êî∂Âà∞ [Parameter] ÊôÇË¶ÅÂü∑Ë°åÁöÑÈÇèËºØ
            Console.WriteLine("üöÄ Á¨¨‰∏ÄÊ¨°Êé•Êî∂Âà∞ÂèÉÊï∏ currentCardInfoÔºÅ");
        }
    }

    

    public enum SettingStatus
    {
        YET         = 1,
        PROGRESS    = 2,
        DONE        = 3,
    }

    public enum INFO_SETTING_STAGE
    {
        CLOSE_ALL                       = 0,
        ADD_ROW_STAGE                   = 1,
        SELECT_ICON_STAGE               = 2,
        SETTING_VALUE_AND_CMD_STAGE     = 3,
        MACHINE_SELECTION_STAGE         = 4,
        CMD_SELECTION_STAGE             = 5,
        UNIT_SELECTION_STAGE            = 6,
    }


    public class INFO_DataItem
    {
        public string iconPath { get; set; }
        public SettingStatus status {get; set; } = SettingStatus.YET;
        
        public string MachineName {get; set;}
        public string Cmd {get; set;}
        public string ValueName {get; set;}
        public string Unit  {get; set;}
    }


    private List<INFO_DataItem> INFO_DataItems = new List<INFO_DataItem>
    {
        new INFO_DataItem()
    };

    private void AddRow()
    {
        INFO_DataItems.Add(new INFO_DataItem());
    }

    private void getImgFiles()
    {
        if(Directory.Exists(imgFolderPath))
        {
            
            imgRelativePaths = Directory.GetFiles(imgFolderPath)
                                    .Select(path => "images/user_selections/" + Path.GetFileName(path))
                                    .ToList();
            foreach(var names in imgRelativePaths)
            {
                Console.WriteLine(names);
            }
        }
        else
        {
            Console.WriteLine("FAIL : getImgFiles");
        }
    }

    private async Task getCMDs()
    {
        if(File.Exists(Cmd_filePath))
        {
            string json = File.ReadAllText(Cmd_filePath);
            cmdDict = JObject.Parse(json);

            @* var json = await File.ReadAllTextAsync(Cmd_filePath);
            cmdDict = JsonSerializer.Deserialize<Dictionary<string, object>>(json);

            var jsonString = JsonSerializer.Serialize(cmdDict, new JsonSerializerOptions { WriteIndented = true });
            Console.WriteLine(jsonString); *@

        }
    }

    private void selectImg(INFO_DataItem _temp_Info_DataItem)
    {
        currentEdit_INFO_DataItem = _temp_Info_DataItem;
        INFO_setting_stage = INFO_SETTING_STAGE.SELECT_ICON_STAGE;
    }

    private void selectedImgFile(string _imgPath)
    {
        Console.WriteLine(_imgPath);

        currentEdit_INFO_DataItem.iconPath = _imgPath;
        INFO_setting_stage = INFO_SETTING_STAGE.ADD_ROW_STAGE;
    }

    private void setValueAndCmd(INFO_DataItem _temp_Info_DataItem)
    {
        Console.WriteLine("setValueAndCmd");
        currentEdit_INFO_DataItem = _temp_Info_DataItem;
        INFO_setting_stage = INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE;
    }

    private void selectMachine()
    {
        Console.WriteLine("selectMachine");
        INFO_setting_stage = INFO_SETTING_STAGE.MACHINE_SELECTION_STAGE;
    }

    private void selectCMD()
    {
        Console.WriteLine("selectCMD");
        INFO_setting_stage = INFO_SETTING_STAGE.CMD_SELECTION_STAGE;
    }

    private void selectUnit()
    {
        Console.WriteLine("selectUnit");
        if(!string.IsNullOrEmpty(temp_INFO_DataItem.Cmd))
        {
            if(cmdDict.ContainsKey(temp_INFO_DataItem.Cmd))
            {
                var unitToken = cmdDict[temp_INFO_DataItem.Cmd]["Unit"];
                if(unitToken != null)
                {
                    UnitLists = cmdDict[temp_INFO_DataItem.Cmd]["Unit"].ToObject<List<string>>();
                }
            }
            Console.WriteLine(UnitLists);
        }

        INFO_setting_stage = INFO_SETTING_STAGE.UNIT_SELECTION_STAGE;
    }

    private void clickMachineName(string _selectedMachineName)
    {
        temp_INFO_DataItem.MachineName = _selectedMachineName;
        INFO_setting_stage = INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE;
        
    }
    private void clickCmd(string _cmd)
    {
        temp_INFO_DataItem.Cmd = _cmd;
        INFO_setting_stage = INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE;
    }
    private void clickUnit(string _unit)
    {
        temp_INFO_DataItem.Unit = _unit;
        INFO_setting_stage = INFO_SETTING_STAGE.SETTING_VALUE_AND_CMD_STAGE;
    }

    private void confirmInfoValueSetting()
    {
        if( string.IsNullOrEmpty(temp_INFO_DataItem.MachineName)    ||
            string.IsNullOrEmpty(temp_INFO_DataItem.Cmd))
        {
            Console.WriteLine("ÊúâÊï∏ÂÄºÊ≤íÊúâË®≠ÂÆö");
            return;
        }

        
        currentEdit_INFO_DataItem.MachineName   = temp_INFO_DataItem.MachineName;
        currentEdit_INFO_DataItem.Cmd           = temp_INFO_DataItem.Cmd;
        currentEdit_INFO_DataItem.ValueName     = temp_INFO_DataItem.ValueName;
        currentEdit_INFO_DataItem.Unit          = "";
        currentEdit_INFO_DataItem.status        = SettingStatus.DONE;
        
        INFO_setting_stage = INFO_SETTING_STAGE.ADD_ROW_STAGE;
    }
}